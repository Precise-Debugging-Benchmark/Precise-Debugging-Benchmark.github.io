<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Python Debugging Annotation Platform</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* Ensure the app takes full viewport height */
        body, html {
            height: 100%;
            margin: 0;
            background-color: #f4f6f8;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

       .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1600px;
            margin: 0 auto;
            background: #fff;
            box-shadow: 0 0 20px rgba(0,0,0,0.05);
        }

        /* Header Section */
       .header {
            padding: 15px 25px;
            border-bottom: 1px solid #e0e0e0;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

       .header h1 {
            font-size: 1.2rem;
            margin: 0;
            font-weight: 600;
            color: #2c3e50;
        }

        /* Workspace: The Split Pane */
       .workspace {
            flex: 1;
            display: flex;
            overflow: hidden; /* Prevent body scroll */
        }

        /* Left Panel: Instructions */
       .panel-left {
            width: 40%;
            padding: 0;
            border-right: 1px solid #e0e0e0;
            display: flex;
            flex-direction: column;
            background: #fcfcfc;
        }

       .scrollable-content {
            flex: 1;
            overflow-y: auto;
            padding: 25px;
        }

        /* Right Panel: Editor */
       .panel-right {
            width: 60%;
            display: flex;
            flex-direction: column;
            background: #fff;
        }

        /* Ace Editor Container */
        #editor-container {
            flex: 1;
            position: relative;
        }

        /* Instruction Box Styling */
       .instruction-box {
            background-color: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 25px;
            font-size: 0.95rem;
        }

       .task-meta {
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: #666;
            font-family: monospace;
        }

       .prompt-text {
            font-size: 1rem;
            line-height: 1.6;
            color: #333;
            white-space: pre-wrap; /* Preserve formatting in prompt */
        }

        /* Unit Test Section */
       .test-section {
            margin-top: 30px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }

       .test-content {
            background: #2b2b2b;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 6px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9rem;
            white-space: pre-wrap;
            display: none; /* Initially Hidden */
            margin-top: 15px;
            border: 1px solid #444;
        }

        /* Footer Controls */
       .control-bar {
            padding: 15px 25px;
            border-top: 1px solid #e0e0e0;
            background: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Visual Marker for Frozen Lines */
       .readonly-highlight {
            position: absolute;
            background-color: rgba(230, 230, 230, 0.5);
            z-index: 20;
        }
    </style>
</head>
<body>

<div class="app-container">
    <header class="header">
        <div>
            <h1>Python Debugging Task</h1>
            <div id="task-id-display" class="task-meta">Loading Task ID...</div>
        </div>
        <div>
            <span class="badge bg-secondary" id="progress-display">Task 0 / 0</span>
            <span class="badge bg-success" id="status-display" style="display:none">Completed</span>
        </div>
    </header>

    <div class="workspace">

        <div class="panel-left">
            <div class="scrollable-content">
                <div class="instruction-box">
                    <strong>Instructions:</strong> Debug the Python code below.
                    <ul class="mb-0 mt-1 ps-3">
                        <li><strong>ONLY</strong> fix the bugs. Make minimal edits.</li>
                        <li>Do <strong>NOT</strong> generate a new solution.</li>
                        <li>Do <strong>NOT</strong> reformat correct lines.</li>
                        <li>Do <strong>NOT</strong> edit or add comments.</li>
                        <li>The function signature (grayed out) is <strong>FROZEN</strong> and cannot be edited.</li>
                    </ul>
                </div>

                <h5 class="mb-3">Task Description</h5>
                <div id="task-prompt" class="prompt-text">
                    Loading prompt...
                </div>

                <div class="test-section">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0">Verification Tests</h6>
                        <button class="btn btn-sm btn-outline-primary" onclick="toggleTests()">
                            <span id="btn-text-test">Show Tests</span>
                        </button>
                    </div>
                    <div id="test-container" class="test-content"></div>
                </div>
            </div>
        </div>

        <div class="panel-right">
            <div id="editor-container"></div>

            <div class="control-bar">
                <button class="btn btn-outline-secondary" onclick="prevTask()" id="btn-prev">Previous</button>

                <div class="d-flex gap-2">
                    <button class="btn btn-success px-4" onclick="submitAndNext()">Submit Code</button>
                    <button class="btn btn-primary" onclick="downloadResults()">Download JSON Results</button>
                </div>

                <button class="btn btn-outline-secondary" onclick="nextTask()" id="btn-next">Skip / Next</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.5/ace.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.5/mode-python.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.5/theme-github.min.js"></script>

<script>
    /**
     * Application State
     */
    const AppState = {
        data:,           // Holds the full dataset
        results: {},        // Map<TaskId, AnnotatedCode>
        currentIndex: 0,    // Pointer to current task
        editor: null        // Ace instance
    };

    /**
     * Initialization Sequence
     */
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await loadDataset();
            initializeEditor();
            renderCurrentTask();
        } catch (e) {
            alert("Initialization Failed: " + e.message);
            console.error(e);
        }
    });

    /**
     * Data Fetching
     * Loads data.json relative to the HTML file.
     */
    async function loadDataset() {
        const response = await fetch('data.json');
        if (!response.ok) throw new Error(`HTTP Error ${response.status}`);
        AppState.data = await response.json();

        // Initialize results map with nulls
        AppState.data.forEach(task => {
            if (!AppState.results[task.task_id]) {
                AppState.results[task.task_id] = null;
            }
        });

        updateProgressUI();
    }

    /**
     * Editor Configuration
     * Sets up Ace Editor with Python mode and the "Frozen Line" Interceptor.
     */
    function initializeEditor() {
        AppState.editor = ace.edit("editor-container");
        AppState.editor.setTheme("ace/theme/github");
        AppState.editor.session.setMode("ace/mode/python");
        AppState.editor.setShowPrintMargin(false);
        AppState.editor.setFontSize(14);

        // --- The Frozen Line Logic ---
        // This intercepts every command sent to the editor
        AppState.editor.commands.on("exec", function(e) {
            const task = AppState.data;
            if (!task) return;

            const frozenCount = task.frozen_lines |

| 0;
            if (frozenCount === 0) return;

            // Define allowable navigation commands (read-only actions)
            const allowedCommands = [
                "up", "down", "left", "right",
                "select", "goto", "find",
                "copy", "focus"
            ];

            // Check if command is purely navigation
            // e.command.name holds the internal command string (e.g., "insertstring", "backspace")
            const isNavigation = allowedCommands.some(cmd => e.command.name.includes(cmd));

            // If it's an editing command (or typing), check the cursor position
            if (!isNavigation) {
                const cursor = AppState.editor.selection.getCursor();
                const selection = AppState.editor.selection.getRange();

                // 1. Block if cursor is inside frozen lines (Rows 0 to frozenCount-1)
                if (cursor.row < frozenCount) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // 2. Block if selection overlaps frozen lines
                if (selection.start.row < frozenCount) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }

                // 3. Special Case: Backspace at the start of the first editable line
                // This prevents merging the editable line into the frozen line
                if (e.command.name === "backspace" &&
                    cursor.row === frozenCount &&
                    cursor.column === 0) {
                    e.preventDefault();
                    e.stopPropagation();
                    return;
                }
            }
        });
    }

    /**
     * Render Logic
     * Populates the UI with data from the current task index.
     */
    function renderCurrentTask() {
        const task = AppState.data;

        // Update Text Fields
        document.getElementById('task-id-display').textContent = `ID: ${task.task_id}`;
        document.getElementById('task-prompt').innerText = task.task_prompt; // innerText is safer
        document.getElementById('test-container').innerText = task.test |

| "No tests provided.";

        // Reset Test Visibility
        document.getElementById('test-container').style.display = 'none';
        document.getElementById('btn-text-test').textContent = "Show Tests";

        // Load Code into Editor
        // Priority: Saved Draft > Original Buggy Code
        const savedCode = AppState.results[task.task_id];
        const codeToDisplay = savedCode!== null? savedCode : task.buggy_code;

        AppState.editor.setValue(codeToDisplay, -1); // -1 moves cursor to start

        // Apply Visual Freeze Markers
        visualizeFrozenLines(task.frozen_lines);

        updateProgressUI();
    }

    /**
     * Visualization of Frozen Zones
     * Uses Ace Markers to draw a background behind read-only lines.
     */
    function visualizeFrozenLines(count) {
        const session = AppState.editor.getSession();

        // Clear existing markers to prevent buildup
        const markers = session.getMarkers();
        for (let id in markers) {
            if (markers[id].clazz === 'readonly-highlight') {
                session.removeMarker(id);
            }
        }

        if (!count) return;

        const Range = ace.require('ace/range').Range;
        // Marker from (Row 0, Col 0) to (Row count-1, Infinity)
        const range = new Range(0, 0, count - 1, 1000);
        session.addMarker(range, "readonly-highlight", "fullLine");
    }

    /**
     * UI Actions
     */
    function toggleTests() {
        const container = document.getElementById('test-container');
        const btnText = document.getElementById('btn-text-test');
        if (container.style.display === 'none') {
            container.style.display = 'block';
            btnText.textContent = "Hide Tests";
        } else {
            container.style.display = 'none';
            btnText.textContent = "Show Tests";
        }
    }

    function saveCurrentWork() {
        const task = AppState.data;
        const currentCode = AppState.editor.getValue();
        AppState.results[task.task_id] = currentCode;
    }

    function submitAndNext() {
        saveCurrentWork();
        // Here you could add simple validation (e.g., check syntax or length)
        nextTask();
    }

    function nextTask() {
        if (AppState.currentIndex < AppState.data.length - 1) {
            saveCurrentWork(); // Auto-save on nav
            AppState.currentIndex++;
            renderCurrentTask();
        } else {
            alert("You have reached the end of the dataset. Please download your results.");
        }
    }

    function prevTask() {
        if (AppState.currentIndex > 0) {
            saveCurrentWork(); // Auto-save on nav
            AppState.currentIndex--;
            renderCurrentTask();
        }
    }

    function updateProgressUI() {
        const total = AppState.data.length;
        const current = AppState.currentIndex + 1;
        const completed = Object.values(AppState.results).filter(v => v!== null).length;

        document.getElementById('progress-display').textContent = `Task ${current} / ${total}`;

        // Update button states
        document.getElementById('btn-prev').disabled = (AppState.currentIndex === 0);
        document.getElementById('btn-next').disabled = (AppState.currentIndex === total - 1);

        // Completion indicator
        const isDone = AppState.results.task_id]!== null;
        document.getElementById('status-display').style.display = isDone? 'inline-block' : 'none';
    }

    /**
     * Export / Download Logic
     * Uses Blob API to generate a JSON file.
     */
    function downloadResults() {
        // Construct the output array based on user progress
        const output = AppState.data.map(task => ({
            task_id: task.task_id,
            original_code: task.buggy_code,
            // If user visited/submitted, use that. Else, use original or null.
            final_code: AppState.results[task.task_id] |

| task.buggy_code,
            status: AppState.results[task.task_id]? "annotated" : "skipped"
        }));

        const dataStr = JSON.stringify(output, null, 2);
        const blob = new Blob(, { type: "application/json" });
        const url = URL.createObjectURL(blob);

        // Create invisible link and click it
        const a = document.createElement('a');
        a.href = url;
        a.download = `annotation_results_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a);
        a.click();

        // Cleanup
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }
</script>

</body>
</html>